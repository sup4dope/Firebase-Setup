rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- [1] 기본 권한 검사 함수들 ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserRole() {
      // 마이그레이션 덕분에 ID로 바로 역할 조회가 가능해짐 (매우 빠름)
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isSuperAdmin() {
      return isSignedIn() && getUserRole() == 'super_admin';
    }
    
    // 본인 문서인지 확인 (userId 필드나 문서 ID와 대조)
    function isOwnDocument(userId) {
      return request.auth.uid == userId;
    }
    
    // 문서 내에 ownerId나 userId 필드가 본인 것인지 확인
    // settlements 전용 소유자 확인 함수 추가
function isSettlementOwner() {
  return resource.data.manager_id == request.auth.uid;
}

match /settlements/{docId} {
  allow read: if isSignedIn();  // 로그인한 모든 사용자 읽기 허용
  allow write: if isSuperAdmin();  // 쓰기는 관리자만
}

    // --- [2] 컬렉션별 규칙 ---

    // 1. 상담 문의 (랜딩페이지)
    match /consultations/{docId} {
      allow create: if true; // 외부 고객 입력 허용
      allow read, update: if isSignedIn(); // 직원은 보기/수정 가능
      allow delete: if isSuperAdmin(); // ★수정: 삭제는 오직 대표님만!
    }

    // 2. 유저 정보 (직원 관리)
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, delete: if isSuperAdmin();
      allow update: if isSuperAdmin() || isOwnDocument(userId);
    }

    // 3. 팀 관리
    match /teams/{teamId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    // 4. 고객 정보 (CRM 핵심)
    match /customers/{customerId} {
      allow read: if isSignedIn(); // 모든 직원이 고객 목록 조회 가능
      allow create, update: if isSignedIn();
      allow delete: if isSuperAdmin(); // 삭제는 관리자만 (안전장치)
    }


    // 6. 회사 전체 지출/수익 (가장 중요 ★)
    match /company_expenses/{docId} {
      allow read, write: if isSuperAdmin(); // 절대적으로 관리자만 접근
    }
    
    // 7. 기타 운영 데이터
    match /holidays/{docId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    match /todos/{docId} {
      allow read, write: if isSignedIn();
    }
    match /todo_list/{docId} {
  allow read, write: if isSignedIn();
}
    match /status_logs/{docId} {
      allow read, write: if isSignedIn();
    }

    match /customer_history_logs/{docId} {
      allow read, write: if isSignedIn();
    }

    match /counseling_logs/{docId} {
      allow read, write: if isSignedIn();
    }

    match /meta/{docId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin();
    }

    match /contract_history/{docId} {
      allow read, write: if isSignedIn();
    }
  }
}